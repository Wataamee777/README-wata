name: Site Status Check

on:
  schedule:
    - cron: '*/5 * * * *'
  workflow_dispatch:

permissions:
  contents: write

jobs:
  check:
    runs-on: ubuntu-latest
    timeout-minutes: 3

    steps:
      - uses: actions/checkout@v4

      - name: Run status check
        run: |
          SITES=(
            "hatoage.wata777.f5.si"
            "sakura.kotoca.net"
          )

          BOT_SITE="bot.sakurahp.f5.si"

          STATUS_FILE="status.json"
          TMP_FILE="status_new.json"

          echo "{" > "$TMP_FILE"

          # ===== 通常サイト =====
          for i in "${!SITES[@]}"; do
            SITE="${SITES[$i]}"

            NSLOOKUP=$(nslookup "$SITE" >/dev/null 2>&1 && echo true || echo false)

            HTTP_INFO=$(curl -s -m 8 -k -o /dev/null \
              -w "%{http_code} %{time_total}" \
              -A "Mozilla/5.0" \
              "https://$SITE" || echo "000 ")

            HTTP=$(echo "$HTTP_INFO" | awk '{print $1}')
            TIME_TOTAL=$(echo "$HTTP_INFO" | awk '{print $2}')

            if [ "$HTTP" = "000" ] || [ -z "$TIME_TOTAL" ]; then
              HTTP_MS=null
            else
              HTTP_MS=$(awk "BEGIN { printf \"%.0f\", $TIME_TOTAL * 1000 }")
            fi

            if [ "$NSLOOKUP" = "false" ]; then
              STATUS="dns_error"
            elif [ "$HTTP" -ge 500 ] || [ "$HTTP" = "000" ]; then
              STATUS="down"
            elif [ "$HTTP" -ge 400 ]; then
              STATUS="warning"
            else
              STATUS="ok"
            fi

            TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

            echo "  \"$SITE\": {" >> "$TMP_FILE"
            echo "    \"type\": \"site\"," >> "$TMP_FILE"
            echo "    \"status\": \"$STATUS\"," >> "$TMP_FILE"
            echo "    \"nslookup\": $NSLOOKUP," >> "$TMP_FILE"
            echo "    \"http\": $HTTP," >> "$TMP_FILE"
            echo "    \"http_ms\": $HTTP_MS," >> "$TMP_FILE"
            echo "    \"checked_at\": \"$TIMESTAMP\"" >> "$TMP_FILE"
            echo -n "  }," >> "$TMP_FILE"
            echo "" >> "$TMP_FILE"
          done

          # ===== Discord Bot（Shard）=====
          BOT_JSON=$(curl -s -m 8 "https://$BOT_SITE/shards/status/" || echo "")

          if echo "$BOT_JSON" | grep -q '"ok":true'; then
            SHARD_STATUS="ok"
          else
            SHARD_STATUS="down"
          fi

          echo "  \"$BOT_SITE\": {" >> "$TMP_FILE"
          echo "    \"type\": \"discord_bot\"," >> "$TMP_FILE"
          echo "    \"status\": \"$SHARD_STATUS\"," >> "$TMP_FILE"
          echo "    \"raw\": $BOT_JSON" >> "$TMP_FILE"
          echo "  }" >> "$TMP_FILE"

          echo "}" >> "$TMP_FILE"

          # 差分がある時だけ更新
          if [ ! -f "$STATUS_FILE" ] || ! diff -q "$STATUS_FILE" "$TMP_FILE" >/dev/null; then
            mv "$TMP_FILE" "$STATUS_FILE"
            echo "UPDATED=true" >> "$GITHUB_ENV"
          else
            rm "$TMP_FILE"
            echo "UPDATED=false" >> "$GITHUB_ENV"
          fi

      - name: Commit and push
        if: env.UPDATED == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
          git add status.json
          git commit -m "chore: update site & shard status"
          git pull --rebase
          git push
