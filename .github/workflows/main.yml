name: Update Discord Profile

permissions:
  contents: write

on:
  schedule:
    - cron: "*/5 * * * *" # 5分ごと
  workflow_dispatch:

jobs:
  fetch-discord:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch Discord profile
        env:
          TOKEN: ${{ secrets.DISCORD_TOKEN }}
          USER_ID: "1099098129338466385"
          GUILD_ID: "1391264661554335845"
        run: |
          base="https://cdn.discordapp.com"

          # Discord API から取得
          curl -s -H "Authorization: Bot $TOKEN" \
            https://discord.com/api/v10/users/$USER_ID > profile.json

          curl -s -H "Authorization: Bot $TOKEN" \
            https://discord.com/api/v10/guilds/$GUILD_ID/members/$USER_ID > member.json

          curl -s -H "Authorization: Bot $TOKEN" \
            https://discord.com/api/v10/guilds/$GUILD_ID > guild.json

          # 外部 jq で最低限整形
          jq -s --arg base "$base" -f .github/workflows/process_discord.jq profile.json member.json guild.json > discord_min.json

      - name: Translate public_flags
        run: |
          node <<'JS'
          const fs = require('fs');
          const flagsMap = {
            1: "Discordスタッフ",
            2: "パートナー",
            4: "HypeSquad",
            8: "バグハンター（レベル1）",
            64: "HypeSquad Bravery（赤）",
            128: "HypeSquad Brilliance（青）",
            256: "HypeSquad Balance（緑）",
            512: "早期サポーター",
            16384: "バグハンター（レベル2）",
            131072: "認証済みBot開発者",
            4194304: "アクティブデベロッパー",
            33554432: "クエスト参加者",
            41943040: "オーブ保持者"
          };
          const data = JSON.parse(fs.readFileSync('discord_min.json'));
          const pf = data.public_flags_raw || 0;
          data.public_flags = Object.entries(flagsMap).filter(([k]) => (pf & k) != 0).map(([_,v]) => v);
          fs.writeFileSync('discord.json', JSON.stringify(data, null, 2));
          JS

      - name: Commit JSON
        run: |
          git config user.name Wataamee777
          git config user.email wataamee777@gmail.com
          git add discord.json
          git commit -m "update discord profile" || echo "No changes to commit"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/Wataamee777/README-wata.git HEAD:main
