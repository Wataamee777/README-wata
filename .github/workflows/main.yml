name: update discord
permissions:
  contents: write

on:
  schedule:
    - cron: "*/5 * * * *" # 5åˆ†ã”ã¨
  workflow_dispatch:

jobs:
  fetch-discord:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Fetch Discord profile
        env:
          TOKEN: ${{ secrets.DISCORD_TOKEN }}
          USER_ID: "1099098129338466385"
          GUILD_ID: "1391264661554335845"
        run: |
          base="https://cdn.discordapp.com"

          # Discord API ã‹ã‚‰å–å¾—
          curl -s -H "Authorization: Bot $TOKEN" \
            https://discord.com/api/v10/users/$USER_ID > profile.json

          curl -s -H "Authorization: Bot $TOKEN" \
            https://discord.com/api/v10/guilds/$GUILD_ID/members/$USER_ID > member.json

          curl -s -H "Authorization: Bot $TOKEN" \
            https://discord.com/api/v10/guilds/$GUILD_ID > guild.json

          # ãƒ•ãƒ©ã‚°æ—¥æœ¬èªžå¯¾å¿œ
          cat > flags.json <<'EOF'
          {
            "1": "Discordã‚¹ã‚¿ãƒƒãƒ•",
            "2": "ãƒ‘ãƒ¼ãƒˆãƒŠãƒ¼",
            "4": "HypeSquad",
            "8": "ãƒã‚°ãƒãƒ³ã‚¿ãƒ¼ï¼ˆãƒ¬ãƒ™ãƒ«1ï¼‰",
            "64": "HypeSquad Braveryï¼ˆèµ¤ï¼‰",
            "128": "HypeSquad Brillianceï¼ˆé’ï¼‰",
            "256": "HypeSquad Balanceï¼ˆç·‘ï¼‰",
            "512": "æ—©æœŸã‚µãƒãƒ¼ã‚¿ãƒ¼",
            "16384": "ãƒã‚°ãƒãƒ³ã‚¿ãƒ¼ï¼ˆãƒ¬ãƒ™ãƒ«2ï¼‰",
            "131072": "èªè¨¼æ¸ˆã¿Boté–‹ç™ºè€…",
            "4194304": "ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ãƒ‡ãƒ™ãƒ­ãƒƒãƒ‘ãƒ¼",
            "33554432": "ã‚¯ã‚¨ã‚¹ãƒˆå‚åŠ è€…",
            "41943040": "ã‚ªãƒ¼ãƒ–ä¿æŒè€…"
          }
          EOF

          # jqã§æ•´å½¢
          jq --arg base "$base" -s '
            def flags_to_names(flags):
              (input | to_entries | map(select((.key|tonumber) and (flags & ( .key|tonumber ) != 0)) | .value));

            def status_name(s):
              if s == "online" then "ðŸŸ¢ ã‚ªãƒ³ãƒ©ã‚¤ãƒ³"
              elif s == "idle" then "ðŸŒ™ é€€å¸­ä¸­"
              elif s == "dnd" then "â›” å–ã‚Šè¾¼ã¿ä¸­"
              else "ðŸ”˜ ã‚ªãƒ•ãƒ©ã‚¤ãƒ³" end;

            def to_hex(n):
              if n == null then null else "#"+(n | tonumber | tostring | tonumber | toString(16)) end;

            .[0]
            + { 
                avatar: (if .[0].avatar then ($base + "/avatars/" + .[0].id + "/" + .[0].avatar + ".png") else null end),
                banner: (if .[0].banner then ($base + "/banners/" + .[0].id + "/" + .[0].banner + ".png") else null end),
                banner_color: .[0].banner_color,
                accent_color: (.accent_color | to_hex),
                status: (.[1].presence.status | status_name),
                clan: {
                  id: .[2].id,
                  name: .[2].name,
                  icon: (if .[2].icon then ($base + "/icons/" + .[2].id + "/" + .[2].icon + ".png") else null end)
                },
                public_flags: (.[0].public_flags | flags_to_names)
              }
            | del(.discriminator, .discussions, .collectibles)
          ' profile.json member.json guild.json flags.json > discord.json

      - name: Commit JSON
        run: |
          git config user.name Wataamee777
          git config user.email wataamee777@gmail.com
          git add discord.json
          git commit -m "update discord profile" || echo "No changes to commit"
          git push https://x-access-token:${GITHUB_TOKEN}@github.com/Wataamee777/README-wata.git HEAD:main
